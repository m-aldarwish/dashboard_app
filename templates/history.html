<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Historical Data | Hydrogen System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Poppins', sans-serif;
      color: #212529;
    }
    .navbar {
      background: linear-gradient(90deg, #0D6EFD, #0B5345);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .navbar-brand {
      font-weight: 600;
      color: white !important;
    }
    .card {
      background: white;
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    h4 {
      color: #0B5345;
      font-weight: 600;
    }
    footer {
      text-align: center;
      color: #6c757d;
      margin-top: 40px;
      font-size: 0.9rem;
    }
    #downloadCSV {
      background: white;
      border: 2px solid #0B5345;
      color: #0B5345;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    #downloadCSV:hover {
      background: #0B5345;
      color: white;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <span class="navbar-brand">Hydrogen System - Live Historical Data</span>
      <div>
        <span class="text-light me-3">Logged in as: {{ user }} ({{ role }})</span>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-sm me-2">Dashboard</a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold text-success">Live Sensor Trends</h3>
      <button id="downloadCSV" class="btn btn-outline-success btn-sm">
        ⬇️ Download CSV
      </button>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card">
          <h4>Gas ADC</h4>
          <canvas id="gasChart" height="120"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <h4>Temperature (°C)</h4>
          <canvas id="tempChart" height="120"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <h4>Current (A)</h4>
          <canvas id="currentChart" height="120"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card">
          <h4>Voltage (V)</h4>
          <canvas id="voltageChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <footer>ACWA Power × Hackathon 2025 | Smart Hydrogen Monitoring Platform</footer>

  <script>
    // ----- Chart.js Setup -----
    const createChart = (ctx, label, color) => new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderColor: color,
          tension: 0.35,
          fill: false,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: {
            ticks: { color: '#495057' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          y: {
            ticks: { color: '#495057' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#0B5345',
            titleColor: 'white',
            bodyColor: 'white'
          }
        }
      }
    });

    const charts = {
      gas_adc: createChart(document.getElementById('gasChart'), 'Gas ADC', '#198754'),
      temperature_c: createChart(document.getElementById('tempChart'), 'Temperature (°C)', '#fd7e14'),
      current_a: createChart(document.getElementById('currentChart'), 'Current (A)', '#0d6efd'),
      voltage_v: createChart(document.getElementById('voltageChart'), 'Voltage (V)', '#6610f2')
    };

    // ----- Live Data Stream -----
    let csvData = [];
    const evtSource = new EventSource("/stream");

    evtSource.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const hist = data.history;
      if (!hist || hist.length === 0) return;
      const last = hist[hist.length - 1];
      const t = new Date(last.timestamp * 1000).toLocaleTimeString();

      // Store for CSV export
      csvData.push({
        Time: t,
        Gas_ADC: last.gas_adc,
        Temperature_C: last.temperature_c,
        Current_A: last.current_a,
        Voltage_V: last.voltage_v
      });

      // Update charts
      Object.keys(charts).forEach(key => {
        const chart = charts[key];
        if (!chart) return;
        const dataset = chart.data.datasets[0];
        if (chart.data.labels.length && chart.data.labels.at(-1) === t) return;
        chart.data.labels.push(t);
        dataset.data.push(last[key]);
        if (dataset.data.length > 50) {
          chart.data.labels.shift();
          dataset.data.shift();
        }
        chart.update();
      });
    };

    // ----- CSV Export -----
    document.getElementById('downloadCSV').addEventListener('click', () => {
      if (csvData.length === 0) {
        alert("No data available yet!");
        return;
      }
      let csvContent = "data:text/csv;charset=utf-8,Time,Gas_ADC,Temperature_C,Current_A,Voltage_V\n";
      csvData.forEach(row => {
        csvContent += `${row.Time},${row.Gas_ADC},${row.Temperature_C},${row.Current_A},${row.Voltage_V}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "hydrogen_sensor_history.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
